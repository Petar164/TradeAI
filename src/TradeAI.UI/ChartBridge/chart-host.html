<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #0B0E17; }
    #chart { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="chart"></div>
  <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
      width:  window.innerWidth,
      height: window.innerHeight,
      layout: {
        backgroundColor: '#0B0E17',
        textColor:       '#8B8FA8',
        fontSize:        11,
        fontFamily:      'Segoe UI, system-ui, sans-serif',
      },
      grid: {
        vertLines: { color: '#1A1D26', style: LightweightCharts.LineStyle.Solid },
        horzLines: { color: '#1A1D26', style: LightweightCharts.LineStyle.Solid },
      },
      crosshair: {
        vertLine: { color: '#4A4F6A', width: 1, labelBackgroundColor: '#232838' },
        horzLine: { color: '#4A4F6A', width: 1, labelBackgroundColor: '#232838' },
      },
      timeScale: {
        borderColor:    '#232838',
        timeVisible:    true,
        secondsVisible: false,
        rightOffset:    8,
      },
      rightPriceScale: {
        borderColor: '#232838',
      },
      watermark: { visible: false },
      handleScroll: { mouseWheel: true, pressedMouseMove: true },
      handleScale:  { axisPressedMouseMove: true, mouseWheel: true, pinch: true },
    });

    const series = chart.addCandlestickSeries({
      upColor:         '#00C176',
      downColor:       '#FF3B3B',
      borderUpColor:   '#00C176',
      borderDownColor: '#FF3B3B',
      wickUpColor:     '#00C176',
      wickDownColor:   '#FF3B3B',
    });

    // Resize chart when WebView2 container resizes
    const resizeObserver = new ResizeObserver(() => {
      chart.resize(document.getElementById('chart').clientWidth,
                   document.getElementById('chart').clientHeight);
    });
    resizeObserver.observe(document.getElementById('chart'));

    // ── Bridge API (called from C# via ExecuteScriptAsync) ──────────────────
    window.bridge = {
      /** Load a full candle history. data = [{time, open, high, low, close}] */
      loadCandles(data) {
        series.setData(data);
        chart.timeScale().fitContent();
      },

      /** Update or append the latest (partial) candle. */
      updateLastCandle(bar) {
        series.update(bar);
      },
    };

    // ── Notify C# that the chart is ready ───────────────────────────────────
    function notifyReady() {
      if (window.chrome && window.chrome.webview) {
        window.chrome.webview.postMessage(JSON.stringify({ type: 'CHART_READY' }));
      }
    }
    // Small delay so C# WebMessageReceived handler is guaranteed to be wired up
    setTimeout(notifyReady, 100);
  </script>
</body>
</html>
